<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Mate+SC&display=swap" rel="stylesheet">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Oswald&display=swap" rel="stylesheet">
    <title>F2FVCA</title>
</head>
<style>
  .video{
    height:100%;
    width: 100%;
    object-fit: cover;
    border-radius: 20px;
  }
  h1 {
	font-family:" 'Mate SC', serif";
	font-size: 40px;
	color: white;
	background: transparent;
	background-color: #830c84;
	padding: 6px 0 2px 0;
	margin-bottom: 0px;
	text-align: center;
}
  input {
	font-family: 'Oswald', sans-serif;
	text-align: center;
	height: 70px;
	border: none;
	background: transparent;
	font-size: 20px;
	width: 60%;
  margin-top: -10px ;
	border-bottom: 2px solid #6b5a80;
  outline:  none;
}
.sbtn{
   border:1px solid; 
  padding: 4px;
  border-radius: 40%;
}
.sbtn:hover{
  background-color: grey;
  cursor: pointer;
}

</style>
<script>
  const toggle=(id)=>{
    var butval = document.getElementById(id).value
    document.getElementById(id).value = (butval=="0" ? "1" : "0")
    console.log(butval)
  }
</script>
<script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>

<body>
    <h1>Face 2 Face Video Calling App</h1> 
    <div style="display: flex;flex-direction: row;
    justify-content: center;">
    <div>
    <div style="display:flex;align-items: center; padding:10px">
      <br>
      <input id="callingid" placeholder="Enter Peer ID" />
      <img id="callpeer" 
      src="https://www.sellingtimeshares.net/wp-content/uploads/unplug-phone-icon-250x243.png"
      style="top:10px;height:70px;object-fit: cover; width:70px; cursor:pointer; "
      ></img>
      <div id="status"> </div>
    </div>
    <div style="display: flex;align-items: left;">
      <div id="myvideo" style="height: 60vh; width: 45vw; border: 1px ; border-radius: 20px; overflow:hidden"></div>&nbsp;&nbsp;
      <div id="peervideo" style="height: 60vh; width: 45vw; border: 1px; border-radius: 20px; overflow:hidden"></div>
    </div>
    <br/>
    <span>
    <span id="videobutton">
    </span>&nbsp;
    <span id="videostatus"></span></span>&nbsp;
    <span><span id="audiobutton"></span>&nbsp;
    <span id="audiostatus"></span></span>
    
  </div>
  </div>
  <h1 id="peer"></h1>
</body>
<script>
  window.addEventListener('load',(event)=>{
    var peer = new Peer()
    var avlpeer=[]
    peer.on("call",(call)=>{
      navigator.mediaDevices.getUserMedia({video:true,audio:true})
      .then((stream)=>{
      var buttonvid =document.createElement("buttonvideo")
      buttonvid.appendChild(document.createTextNode("Video" ));
      buttonvid.classList.add("sbtn")
      document.getElementById("videostatus").innerHTML = (stream.getVideoTracks()[0].enabled ? "ON" : "OFF")
      buttonvid.onclick=()=>{
        stream.getVideoTracks()[0].enabled = !stream.getVideoTracks()[0].enabled 
        document.getElementById("videostatus").innerHTML = (stream.getVideoTracks()[0].enabled ? "ON" : "OFF")
      }
      document.getElementById("videobutton").append(buttonvid)
      var buttonmic = document.createElement("buttonmic")
      buttonmic.appendChild(document.createTextNode("Mic"))
      buttonmic.classList.add("sbtn")
      document.getElementById("audiostatus").innerHTML = (stream.getAudioTracks()[0].enabled ? "ON" : "OFF")
      buttonmic.onclick=()=>{
        stream.getAudioTracks()[0].enabled = !stream.getAudioTracks()[0].enabled
        document.getElementById("audiostatus").innerHTML = (stream.getAudioTracks()[0].enabled ? "ON" : "OFF")
      }
      document.getElementById("audiobutton").append(buttonmic)
      call.answer(stream)
      addmine(stream)
      call.on('stream',(stream)=>{
      if(!avlpeer.includes(call.peer)){
        remotevideoadder(stream)
        avlpeer.push(call.peer)
        document.getElementById("status").innerHTML = "Recieved Connection from " + call.peer
        }
      })
     }).catch((e)=>{console.log(w)})
    })
    const callpeer=(id)=>{
     navigator.mediaDevices.getUserMedia({video:true,audio:true})
     .then((stream)=>{
      var buttonvid =document.createElement("buttonvideo")
      buttonvid.appendChild(document.createTextNode("Video"));
      buttonvid.classList.add("sbtn")
      document.getElementById("videostatus").innerHTML = (stream.getVideoTracks()[0].enabled ? "ON" : "OFF")
      buttonvid.onclick=()=>{
        stream.getVideoTracks()[0].enabled = !stream.getVideoTracks()[0].enabled 
        document.getElementById("videostatus").innerHTML = (stream.getVideoTracks()[0].enabled ? "ON" : "OFF")
      }
      document.getElementById("videobutton").append(buttonvid)
      var buttonmic = document.createElement("buttonmic")
      buttonmic.appendChild(document.createTextNode("Mic"))
      buttonmic.classList.add("sbtn")
      document.getElementById("audiostatus").innerHTML = (stream.getAudioTracks()[0].enabled ? "ON" : "OFF")
      buttonmic.onclick=()=>{
        stream.getAudioTracks()[0].enabled = !stream.getAudioTracks()[0].enabled
        document.getElementById("audiostatus").innerHTML = (stream.getAudioTracks()[0].enabled ? "ON" : "OFF")
      }
      document.getElementById("audiobutton").append(buttonmic)
      addmine(stream)
      let calling  = peer.call(id,stream)
      calling.on('stream',(stream)=>{
        if(!avlpeer.includes(calling.peer)){
           remotevideoadder(stream)
           avlpeer.push(calling.peer)
           document.getElementById("status").innerHTML = "Connected to " + calling.peer
          }
       })
     }).catch((e)=>{console.log(e)})
    }
    const addmine =(stream)=>{
      let video = document.createElement("video")
      video.classList.add("video")
      video.srcObject = stream;
      video.play()
      video.muted=true
      document.getElementById("myvideo").append(video)
      
    }
    const remotevideoadder=(stream)=>{
      let video = document.createElement("video")
      video.classList.add("video")
      video.srcObject = stream;
      video.play()
      document.getElementById("peervideo").append(video)
    }
    peer.on('open',(id)=>{
      document.getElementById("peer").innerHTML = "Your Id: " + id
     })
     document.getElementById("callpeer").addEventListener('click',(e)=>{
         let otherpeer=document.getElementById("callingid").value
         document.getElementById("status").innerHTML = "connecting to " + otherpeer
         callpeer(otherpeer)
       })
  })
</script>
</html>